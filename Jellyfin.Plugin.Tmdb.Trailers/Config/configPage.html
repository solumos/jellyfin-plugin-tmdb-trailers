<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TMDb Trailers</title>
</head>
<body>
<div data-role="page" class="page type-interior pluginConfigurationPage esqConfigurationPage">
    <div data-role="content">
        <div class="content-primary">
            <form class="esqConfigurationForm">
                <div class="verticalSection verticalSection-extrabottompadding">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">TMDb Trailer Settings:</h2>
                        <a is="emby-button" class="raised button-alt headerHelpButton" target="_blank" href="https://github.com/solumos/jellyfin-plugin-tmdb-trailers">${Help}</a>
                    </div>
                    <div class="verticalSection verticalSection-extrabottompadding">
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtTmdbLanguage" label="Language:" />
                            <div class="fieldDescription">
                                Pass a ISO 639-1 value to display translated data for the fields that support it.
                                minLength: 2
                                pattern: ([a-z]{2})-([A-Z]{2})
                                default: en-US
                                <a is="emby-button" class="raised button-alt" target="_blank" href="https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes">Language Code Reference</a>
                            </div>
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtTmdbRegion" label="Region:" />
                            <div class="fieldDescription">
                                Specify a ISO 3166-1 code to filter release dates. Must be uppercase.
                                pattern: ^[A-Z]{2}$
                                <a is="emby-button" class="raised button-alt" target="_blank" href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2">Language Code Reference</a>
                            </div>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableExtras" />
                                <span>Enable Movie Extras Channel:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableTrailers" />
                                <span>Enable Movie Trailers Channel:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableTrailersUpcoming" />
                                <span>Enable Upcoming Movies Trailers:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableTrailersNowPlaying" />
                                <span>Enable Now Playing Movies Trailers:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableTrailersPopular" />
                                <span>Enable Popular Movies Trailers:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTmdbEnableTrailersTopRated" />
                                <span>Enable Top Rated Movies Trailers:</span>
                            </label>
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtTmdbTrailerLimit" label="Trailer Limit:" />
                            <div class="fieldDescription">
                                The maximum number of trailers to retrieve per category.
                                default: 20
                            </div>
                        </div>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="txtTmdbIntroCount" label="Intro Count:" />
                            <div class="fieldDescription">
                                The number of trailers to play as intros.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cinema Mode Section -->
                <div class="verticalSection verticalSection-extrabottompadding">
                    <h2 class="sectionTitle">Cinema Mode Settings:</h2>
                    <div class="fieldDescription" style="margin-bottom: 1em;">
                        Cinema mode creates a theater-like experience with pre-rolls before trailers and before the feature presentation.
                    </div>

                    <div class="checkboxContainer">
                        <label>
                            <input type="checkbox" is="emby-checkbox" id="chkEnableCinemaMode" />
                            <span>Enable Cinema Mode:</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, uses smart trailer selection and pre-rolls for a theater experience.
                        </div>
                    </div>

                    <div id="cinemaModeSettings" style="margin-left: 1.5em;">
                        <div class="inputContainer">
                            <select is="emby-select" id="selectCinemaModeLibrary" label="Apply Cinema Mode to Library:">
                                <option value="">All Movies</option>
                            </select>
                            <div class="fieldDescription">
                                Only apply cinema mode to movies in this library. Leave as "All Movies" to apply everywhere.
                            </div>
                        </div>

                        <!-- Pre-Roll Settings -->
                        <h3 class="sectionTitle" style="margin-top: 1em;">Pre-Roll Libraries</h3>
                        <div class="fieldDescription">
                            Select Jellyfin libraries containing pre-roll videos. Leave empty to disable.
                        </div>

                        <div class="inputContainer">
                            <select is="emby-select" id="selectTrailerPreRollLibrary" label="Trailer Pre-Roll Library:">
                                <option value="">None</option>
                            </select>
                            <div class="fieldDescription">
                                Video that plays before trailers (e.g., "Coming Attractions").
                            </div>
                        </div>

                        <div class="inputContainer">
                            <select is="emby-select" id="selectFeaturePreRollLibrary" label="Feature Pre-Roll Library:">
                                <option value="">None</option>
                            </select>
                            <div class="fieldDescription">
                                Video that plays after trailers, before the movie (e.g., "Feature Presentation").
                            </div>
                        </div>

                        <!-- Rating Enforcement -->
                        <h3 class="sectionTitle" style="margin-top: 1em;">Rating Enforcement</h3>
                        <div class="fieldDescription">
                            Ensure content ratings are appropriate for the movie being played.
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkEnforceRatingTrailers" />
                                <span>Enforce Rating Limit on Trailers:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTrailerPreRollRatingLimit" />
                                <span>Enforce Rating Limit on Trailer Pre-Rolls:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkFeaturePreRollRatingLimit" />
                                <span>Enforce Rating Limit on Feature Pre-Rolls:</span>
                            </label>
                        </div>

                        <!-- Seasonal Settings -->
                        <h3 class="sectionTitle" style="margin-top: 1em;">Seasonal Content</h3>
                        <div class="fieldDescription">
                            Control seasonal content like Christmas or Halloween themed pre-rolls.
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkTrailerPreRollIgnoreOutOfSeason" />
                                <span>Hide Out-of-Season Trailer Pre-Rolls:</span>
                            </label>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkFeaturePreRollIgnoreOutOfSeason" />
                                <span>Hide Out-of-Season Feature Pre-Rolls:</span>
                            </label>
                        </div>

                        <!-- Selection Rules -->
                        <h3 class="sectionTitle" style="margin-top: 1em;">Trailer Selection Rules</h3>
                        <div class="fieldDescription">
                            Configure how trailers are selected to match the movie being played.
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkRuleGenre" />
                                <span>Match by Genre:</span>
                            </label>
                            <div class="fieldDescription">Prefer trailers that share genres with the movie.</div>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkRuleDecade" />
                                <span>Match by Decade:</span>
                            </label>
                            <div class="fieldDescription">Prefer trailers from the same decade as the movie.</div>
                        </div>
                        <div class="checkboxContainer">
                            <label>
                                <input type="checkbox" is="emby-checkbox" id="chkRuleUnplayed" />
                                <span>Prefer Unplayed Trailers:</span>
                            </label>
                            <div class="fieldDescription">Prioritize trailers the user hasn't seen yet.</div>
                        </div>
                    </div>
                </div>

                <div>
                    <button is="emby-button" type="submit" data-theme="b" class="raised button-submit block">
                        <span>${Save}</span>
                    </button>
                    <button is="emby-button" type="button" class="raised button-cancel block btnCancel" onclick="history.back();">
                        <span>${ButtonCancel}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script type="text/javascript">
        var TmdbTrailerPlugin = {
            pluginUniqueId: "69104C31-D23F-4040-B99C-8913C09751D6",

            // Basic settings
            txtTmdbLanguage: document.getElementById("txtTmdbLanguage"),
            txtTmdbRegion: document.getElementById("txtTmdbRegion"),
            chkTmdbEnableExtras: document.getElementById("chkTmdbEnableExtras"),
            chkTmdbEnableTrailers: document.getElementById("chkTmdbEnableTrailers"),
            chkTmdbEnableTrailersUpcoming: document.getElementById("chkTmdbEnableTrailersUpcoming"),
            chkTmdbEnableTrailersNowPlaying: document.getElementById("chkTmdbEnableTrailersNowPlaying"),
            chkTmdbEnableTrailersPopular: document.getElementById("chkTmdbEnableTrailersPopular"),
            chkTmdbEnableTrailersTopRated: document.getElementById("chkTmdbEnableTrailersTopRated"),
            txtTmdbTrailerLimit: document.getElementById("txtTmdbTrailerLimit"),
            txtTmdbIntroCount: document.getElementById("txtTmdbIntroCount"),

            // Cinema mode settings
            chkEnableCinemaMode: document.getElementById("chkEnableCinemaMode"),
            selectCinemaModeLibrary: document.getElementById("selectCinemaModeLibrary"),
            selectTrailerPreRollLibrary: document.getElementById("selectTrailerPreRollLibrary"),
            selectFeaturePreRollLibrary: document.getElementById("selectFeaturePreRollLibrary"),
            chkEnforceRatingTrailers: document.getElementById("chkEnforceRatingTrailers"),
            chkTrailerPreRollRatingLimit: document.getElementById("chkTrailerPreRollRatingLimit"),
            chkFeaturePreRollRatingLimit: document.getElementById("chkFeaturePreRollRatingLimit"),
            chkTrailerPreRollIgnoreOutOfSeason: document.getElementById("chkTrailerPreRollIgnoreOutOfSeason"),
            chkFeaturePreRollIgnoreOutOfSeason: document.getElementById("chkFeaturePreRollIgnoreOutOfSeason"),
            chkRuleGenre: document.getElementById("chkRuleGenre"),
            chkRuleDecade: document.getElementById("chkRuleDecade"),
            chkRuleUnplayed: document.getElementById("chkRuleUnplayed"),
            cinemaModeSettings: document.getElementById("cinemaModeSettings")
        };

        function updateCinemaModeVisibility() {
            var enabled = TmdbTrailerPlugin.chkEnableCinemaMode.checked;
            TmdbTrailerPlugin.cinemaModeSettings.style.display = enabled ? 'block' : 'none';
        }

        function loadLibraries() {
            window.ApiClient.getVirtualFolders().then(function(folders) {
                var cinemaModeSelect = TmdbTrailerPlugin.selectCinemaModeLibrary;
                var trailerSelect = TmdbTrailerPlugin.selectTrailerPreRollLibrary;
                var featureSelect = TmdbTrailerPlugin.selectFeaturePreRollLibrary;

                // Clear existing options except first option
                while (cinemaModeSelect.options.length > 1) {
                    cinemaModeSelect.remove(1);
                }
                while (trailerSelect.options.length > 1) {
                    trailerSelect.remove(1);
                }
                while (featureSelect.options.length > 1) {
                    featureSelect.remove(1);
                }

                // Add library options
                folders.forEach(function(folder) {
                    var option0 = document.createElement('option');
                    option0.value = folder.ItemId;
                    option0.textContent = folder.Name;
                    cinemaModeSelect.appendChild(option0);

                    var option1 = document.createElement('option');
                    option1.value = folder.ItemId;
                    option1.textContent = folder.Name;
                    trailerSelect.appendChild(option1);

                    var option2 = document.createElement('option');
                    option2.value = folder.ItemId;
                    option2.textContent = folder.Name;
                    featureSelect.appendChild(option2);
                });
            });
        }

        function findRuleByType(rules, type) {
            if (!rules) return null;
            for (var i = 0; i < rules.length; i++) {
                if (rules[i].RuleType === type) {
                    return rules[i];
                }
            }
            return null;
        }

        TmdbTrailerPlugin.chkEnableCinemaMode.addEventListener('change', updateCinemaModeVisibility);

        window.addEventListener("pageshow", function (_) {
            Dashboard.showLoadingMsg();
            loadLibraries();

            window.ApiClient.getPluginConfiguration(TmdbTrailerPlugin.pluginUniqueId).then(function (config) {
                // Basic settings
                TmdbTrailerPlugin.txtTmdbLanguage.value = config.Language || '';
                TmdbTrailerPlugin.txtTmdbRegion.value = config.Region || '';
                TmdbTrailerPlugin.chkTmdbEnableExtras.checked = config.EnableExtrasChannel;
                TmdbTrailerPlugin.chkTmdbEnableTrailers.checked = config.EnableTrailersChannel;
                TmdbTrailerPlugin.chkTmdbEnableTrailersUpcoming.checked = config.EnableTrailersUpcoming;
                TmdbTrailerPlugin.chkTmdbEnableTrailersNowPlaying.checked = config.EnableTrailersNowPlaying;
                TmdbTrailerPlugin.chkTmdbEnableTrailersPopular.checked = config.EnableTrailersPopular;
                TmdbTrailerPlugin.chkTmdbEnableTrailersTopRated.checked = config.EnableTrailersTopRated;
                TmdbTrailerPlugin.txtTmdbTrailerLimit.value = config.TrailerLimit || 20;
                TmdbTrailerPlugin.txtTmdbIntroCount.value = config.IntroCount || 0;

                // Cinema mode settings
                TmdbTrailerPlugin.chkEnableCinemaMode.checked = config.EnableCinemaMode;
                TmdbTrailerPlugin.selectCinemaModeLibrary.value = config.CinemaModeLibrary || '';
                TmdbTrailerPlugin.selectTrailerPreRollLibrary.value = config.TrailerPreRollsLibrary || '';
                TmdbTrailerPlugin.selectFeaturePreRollLibrary.value = config.FeaturePreRollsLibrary || '';
                TmdbTrailerPlugin.chkEnforceRatingTrailers.checked = config.EnforceRatingLimitTrailers;
                TmdbTrailerPlugin.chkTrailerPreRollRatingLimit.checked = config.TrailerPreRollsRatingLimit;
                TmdbTrailerPlugin.chkFeaturePreRollRatingLimit.checked = config.FeaturePreRollsRatingLimit;
                TmdbTrailerPlugin.chkTrailerPreRollIgnoreOutOfSeason.checked = config.TrailerPreRollsIgnoreOutOfSeason;
                TmdbTrailerPlugin.chkFeaturePreRollIgnoreOutOfSeason.checked = config.FeaturePreRollsIgnoreOutOfSeason;

                // Selection rules
                var genreRule = findRuleByType(config.TrailerSelectionRules, 2);
                var decadeRule = findRuleByType(config.TrailerSelectionRules, 1);
                var unplayedRule = findRuleByType(config.TrailerSelectionRules, 4);
                TmdbTrailerPlugin.chkRuleGenre.checked = genreRule ? genreRule.Enabled : true;
                TmdbTrailerPlugin.chkRuleDecade.checked = decadeRule ? decadeRule.Enabled : true;
                TmdbTrailerPlugin.chkRuleUnplayed.checked = unplayedRule ? unplayedRule.Enabled : true;

                updateCinemaModeVisibility();
                Dashboard.hideLoadingMsg();
            });
        });

        document.querySelector(".esqConfigurationForm").addEventListener("submit", function(e){
            Dashboard.showLoadingMsg();
            e.preventDefault();

            window.ApiClient.getPluginConfiguration(TmdbTrailerPlugin.pluginUniqueId).then(function (config) {
                // Basic settings
                config.Language = TmdbTrailerPlugin.txtTmdbLanguage.value;
                config.Region = TmdbTrailerPlugin.txtTmdbRegion.value;
                config.EnableExtrasChannel = TmdbTrailerPlugin.chkTmdbEnableExtras.checked;
                config.EnableTrailersChannel = TmdbTrailerPlugin.chkTmdbEnableTrailers.checked;
                config.EnableTrailersUpcoming = TmdbTrailerPlugin.chkTmdbEnableTrailersUpcoming.checked;
                config.EnableTrailersNowPlaying = TmdbTrailerPlugin.chkTmdbEnableTrailersNowPlaying.checked;
                config.EnableTrailersPopular = TmdbTrailerPlugin.chkTmdbEnableTrailersPopular.checked;
                config.EnableTrailersTopRated = TmdbTrailerPlugin.chkTmdbEnableTrailersTopRated.checked;
                config.TrailerLimit = TmdbTrailerPlugin.txtTmdbTrailerLimit.value;
                config.IntroCount = TmdbTrailerPlugin.txtTmdbIntroCount.value;

                // Cinema mode settings
                config.EnableCinemaMode = TmdbTrailerPlugin.chkEnableCinemaMode.checked;
                config.CinemaModeLibrary = TmdbTrailerPlugin.selectCinemaModeLibrary.value;
                config.TrailerPreRollsLibrary = TmdbTrailerPlugin.selectTrailerPreRollLibrary.value;
                config.FeaturePreRollsLibrary = TmdbTrailerPlugin.selectFeaturePreRollLibrary.value;
                config.EnforceRatingLimitTrailers = TmdbTrailerPlugin.chkEnforceRatingTrailers.checked;
                config.TrailerPreRollsRatingLimit = TmdbTrailerPlugin.chkTrailerPreRollRatingLimit.checked;
                config.FeaturePreRollsRatingLimit = TmdbTrailerPlugin.chkFeaturePreRollRatingLimit.checked;
                config.TrailerPreRollsIgnoreOutOfSeason = TmdbTrailerPlugin.chkTrailerPreRollIgnoreOutOfSeason.checked;
                config.FeaturePreRollsIgnoreOutOfSeason = TmdbTrailerPlugin.chkFeaturePreRollIgnoreOutOfSeason.checked;

                // Selection rules - update existing or create new
                if (!config.TrailerSelectionRules) {
                    config.TrailerSelectionRules = [];
                }

                // Update Genre rule (type 2)
                var genreRule = findRuleByType(config.TrailerSelectionRules, 2);
                if (genreRule) {
                    genreRule.Enabled = TmdbTrailerPlugin.chkRuleGenre.checked;
                } else {
                    config.TrailerSelectionRules.push({ RuleType: 2, Enabled: TmdbTrailerPlugin.chkRuleGenre.checked, Priority: 1 });
                }

                // Update Decade rule (type 1)
                var decadeRule = findRuleByType(config.TrailerSelectionRules, 1);
                if (decadeRule) {
                    decadeRule.Enabled = TmdbTrailerPlugin.chkRuleDecade.checked;
                } else {
                    config.TrailerSelectionRules.push({ RuleType: 1, Enabled: TmdbTrailerPlugin.chkRuleDecade.checked, Priority: 2 });
                }

                // Update Unplayed rule (type 4)
                var unplayedRule = findRuleByType(config.TrailerSelectionRules, 4);
                if (unplayedRule) {
                    unplayedRule.Enabled = TmdbTrailerPlugin.chkRuleUnplayed.checked;
                } else {
                    config.TrailerSelectionRules.push({ RuleType: 4, Enabled: TmdbTrailerPlugin.chkRuleUnplayed.checked, Priority: 3 });
                }

                window.ApiClient.updatePluginConfiguration(TmdbTrailerPlugin.pluginUniqueId, config).then(Dashboard.processPluginConfigurationUpdateResult);
            });

            // Disable default form submission
            return false;
        });
    </script>
</div>
</body>
</html>
